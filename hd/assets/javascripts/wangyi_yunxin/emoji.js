var emoji={"[大笑]":{file:"emoji_0.png"},"[可爱]":{file:"emoji_01.png"},"[色]":{file:"emoji_02.png"},"[嘘]":{file:"emoji_03.png"},"[亲]":{file:"emoji_04.png"},"[呆]":{file:"emoji_05.png"},"[口水]":{file:"emoji_06.png"},"[呲牙]":{file:"emoji_07.png"},"[鬼脸]":{file:"emoji_08.png"},"[害羞]":{file:"emoji_09.png"},"[偷笑]":{file:"emoji_10.png"},"[调皮]":{file:"emoji_11.png"},"[可怜]":{file:"emoji_12.png"},"[敲]":{file:"emoji_13.png"},"[惊讶]":{file:"emoji_14.png"},"[流感]":{file:"emoji_15.png"},"[委屈]":{file:"emoji_16.png"},"[流泪]":{file:"emoji_17.png"},"[嚎哭]":{file:"emoji_18.png"},"[惊恐]":{file:"emoji_19.png"},"[怒]":{file:"emoji_20.png"},"[酷]":{file:"emoji_21.png"},"[不说]":{file:"emoji_22.png"},"[鄙视]":{file:"emoji_23.png"},"[阿弥陀佛]":{file:"emoji_24.png"},"[奸笑]":{file:"emoji_25.png"},"[睡着]":{file:"emoji_26.png"},"[口罩]":{file:"emoji_27.png"},"[努力]":{file:"emoji_28.png"},"[抠鼻孔]":{file:"emoji_29.png"},"[疑问]":{file:"emoji_30.png"},"[怒骂]":{file:"emoji_31.png"},"[晕]":{file:"emoji_32.png"},"[呕吐]":{file:"emoji_33.png"},"[拜一拜]":{file:"emoji_160.png"},"[惊喜]":{file:"emoji_161.png"},"[流汗]":{file:"emoji_162.png"},"[卖萌]":{file:"emoji_163.png"},"[默契眨眼]":{file:"emoji_164.png"},"[烧香拜佛]":{file:"emoji_165.png"},"[晚安]":{file:"emoji_166.png"},"[强]":{file:"emoji_34.png"},"[弱]":{file:"emoji_35.png"},"[OK]":{file:"emoji_36.png"},"[拳头]":{file:"emoji_37.png"},"[胜利]":{file:"emoji_38.png"},"[鼓掌]":{file:"emoji_39.png"},"[握手]":{file:"emoji_200.png"},"[发怒]":{file:"emoji_40.png"},"[骷髅]":{file:"emoji_41.png"},"[便便]":{file:"emoji_42.png"},"[火]":{file:"emoji_43.png"},"[溜]":{file:"emoji_44.png"},"[爱心]":{file:"emoji_45.png"},"[心碎]":{file:"emoji_46.png"},"[钟情]":{file:"emoji_47.png"},"[唇]":{file:"emoji_48.png"},"[戒指]":{file:"emoji_49.png"},"[钻石]":{file:"emoji_50.png"},"[太阳]":{file:"emoji_51.png"},"[有时晴]":{file:"emoji_52.png"},"[多云]":{file:"emoji_53.png"}};

var emojiList = {
	"emoji": {
		"[大笑]":{file:"emoji_0.png"},"[可爱]":{file:"emoji_01.png"},"[色]":{file:"emoji_02.png"},"[嘘]":{file:"emoji_03.png"},"[亲]":{file:"emoji_04.png"},"[呆]":{file:"emoji_05.png"},"[口水]":{file:"emoji_06.png"},"[呲牙]":{file:"emoji_07.png"},"[鬼脸]":{file:"emoji_08.png"},"[害羞]":{file:"emoji_09.png"},"[偷笑]":{file:"emoji_10.png"},"[调皮]":{file:"emoji_11.png"},"[可怜]":{file:"emoji_12.png"},"[敲]":{file:"emoji_13.png"},"[惊讶]":{file:"emoji_14.png"},"[流感]":{file:"emoji_15.png"},"[委屈]":{file:"emoji_16.png"},"[流泪]":{file:"emoji_17.png"},"[嚎哭]":{file:"emoji_18.png"},"[惊恐]":{file:"emoji_19.png"},"[怒]":{file:"emoji_20.png"},"[酷]":{file:"emoji_21.png"},"[不说]":{file:"emoji_22.png"},"[鄙视]":{file:"emoji_23.png"},"[阿弥陀佛]":{file:"emoji_24.png"},"[奸笑]":{file:"emoji_25.png"},"[睡着]":{file:"emoji_26.png"},"[口罩]":{file:"emoji_27.png"},"[努力]":{file:"emoji_28.png"},"[抠鼻孔]":{file:"emoji_29.png"},"[疑问]":{file:"emoji_30.png"},"[怒骂]":{file:"emoji_31.png"},"[晕]":{file:"emoji_32.png"},"[呕吐]":{file:"emoji_33.png"},"[拜一拜]":{file:"emoji_160.png"},"[惊喜]":{file:"emoji_161.png"},"[流汗]":{file:"emoji_162.png"},"[卖萌]":{file:"emoji_163.png"},"[默契眨眼]":{file:"emoji_164.png"},"[烧香拜佛]":{file:"emoji_165.png"},"[晚安]":{file:"emoji_166.png"},"[强]":{file:"emoji_34.png"},"[弱]":{file:"emoji_35.png"},"[OK]":{file:"emoji_36.png"},"[拳头]":{file:"emoji_37.png"},"[胜利]":{file:"emoji_38.png"},"[鼓掌]":{file:"emoji_39.png"},"[握手]":{file:"emoji_200.png"},"[发怒]":{file:"emoji_40.png"},"[骷髅]":{file:"emoji_41.png"},"[便便]":{file:"emoji_42.png"},"[火]":{file:"emoji_43.png"},"[溜]":{file:"emoji_44.png"},"[爱心]":{file:"emoji_45.png"},"[心碎]":{file:"emoji_46.png"},"[钟情]":{file:"emoji_47.png"},"[唇]":{file:"emoji_48.png"},"[戒指]":{file:"emoji_49.png"},"[钻石]":{file:"emoji_50.png"},"[太阳]":{file:"emoji_51.png"},"[有时晴]":{file:"emoji_52.png"},"[多云]":{file:"emoji_53.png"}
	}
}

/**
* 通过正则替换掉文本消息中的emoji表情
* @param text：文本消息内容
*/
function buildEmoji(text) {
	var re = /\[([^\]\[]*)\]/g;
	var matches = text.match(re) || [];
	for (var j = 0, len = matches.length; j < len; ++j) {
		if(emoji[matches[j]]){
			//text = text.replace(matches[j], '<img class="emoji" src="images/emoji/' + emoji[matches[j]].file + '" />');
			text = text.replace(matches[j], '<img class="emoji" src="/hd/assets/images/emoji/' + emoji[matches[j]].file + '" />');
			
		}		
	}
	return text;
}
		
function CEmojiEngine(emNode,emConfig){
	emConfig = emConfig || {};
	this.__init(emNode,emConfig);
};

CEmojiEngine.prototype.__init = function(emNode,emConfig){
	this._emojiList = emConfig.emojiList||[];		//表情列表
	//this._pinupList = emConfig.pinupList||[];		//贴图列表
	this._imgpath =  emConfig.imgpath;			//图片根目录
	this._callback = emConfig.callback||function(){};			//回调函数
	this.__initXGui(emNode,emConfig);		//控件初始化

	this.__renderChangeCol();		//渲染表情选择栏
	this._curEmojiType = 'emoji-emoji';	//初始化当前默认表情选择
	this._curEmojiNode = document.getElementById('chn-emoji-emoji');
	this.__renderPictureCol();		//渲染表情图片栏

	this.__bindEvent();
};

//初始化表情节点
CEmojiEngine.prototype.__initXGui = function(emNode,emConfig){
	this._parentNode = document.createElement('div');
	this._parentNode.className = 'm-emoji-wrapper';
	this._width = emConfig.width||300;
	this._height= emConfig.height||200;
	this._parentNode.style.width =   this._width + 'px';
	this._parentNode.style.height =  'auto';

	this._lWidth = parseInt((this._width-25)/12)-20;		//小的缩略图
	this._hWidth = parseInt((this._width-25)/5)-20;			//大的缩略图

	var tmpdiv= document.createElement('div');
	tmpdiv.className = 'm-emoji-picCol';
	tmpdiv.style.width = this._width + 'px';
	tmpdiv.style.height= this._height + 'px';
	this._parentNode.appendChild(tmpdiv);
	this._pictureColumn= document.createElement('ul');
	this._pictureColumn.className = 'm-emoji-picCol-ul';
	this._pictureColumn.style.width = (this._width-10)+'px';
	this._pictureColumn.style.height= 'auto';
	tmpdiv.appendChild(this._pictureColumn);

	tmpdiv = document.createElement('div');
	tmpdiv.className = 'm-emoji-chnCol';
	tmpdiv.style.width = this._width+'px';
	tmpdiv.style.height= 'auto';
	this._parentNode.appendChild(tmpdiv);

	this._changeColumn = document.createElement('div');
	this._changeColumn.className = 'm-emoji-chnCol-ul';
	this._changeColumn.style.width = 'auto';
	this._changeColumn.style.height= '50px';
	this.tmpguan = document.createElement('b');
	this.tmpguan.className = 'm-emoji-chnCol-guan';
	this.tmpguan.id = 'm-emoji-chnCol-guan';
	this._changeColumn.appendChild(this.tmpguan)
	tmpdiv.appendChild(this._changeColumn);
	if(emNode!=undefined){
		emNode.appendChild(this._parentNode);
	}
};

CEmojiEngine.prototype.__renderChangeCol = function(){
	for(var i in this._emojiList){
		var emojiList = this._emojiList[i];
		for(var key in emojiList){
			var span = document.createElement('span');
			span.id = 'chn-emoji-'+i;	
			var img = new Image();
			img.src = "/hd/assets/images/"+emojiList[key]['file'];
			span.appendChild(img);
			this._changeColumn.appendChild(span);			
			break;
		}			
		if(i=='emoji'){
			span.className = 'f-sel';
		}		
	}
}

CEmojiEngine.prototype.__renderPictureCol= function(){
	this._pictureColumn.innerHTML = ""
	var isEmoji = /^emoji-/.test(this._curEmojiType);
	if(isEmoji){		//表情包
		var subtype = this._curEmojiType.replace('emoji-','');
		var emojiList = this._emojiList[subtype];

		for(var key in emojiList){
			var span = document.createElement('span');
			span.id = 'pic-emoji-'+key;	
			span.style.width = this._lWidth+'px';
			span.style.height= 'auto';
			var img = new Image();
			img.src = '/hd/assets/images/' +subtype+ '/'+ emojiList[key]['file'];
			span.appendChild(img);
			this._pictureColumn.appendChild(span);		
		}		
	}
}

CEmojiEngine.prototype.__bindEvent = function(){
	var that = this;
	//选择表情栏
	this._$addEvent(this._pictureColumn,'click',function(event){
		var target = that._$getElement(event);
		that._$stop(event);
		if(target.tagName.toLowerCase()=='img'){
			target = target.parentNode;
		}else if(target.tagName.toLowerCase()!='span'){
			return;
		}
		var id = target.id;
		var type = /^pic-(\w+)-(.+)$/.exec(id);
		var emoji = type[2];
		type = type[1];
		var category = that._curEmojiType;
		if(type=='emoji'){
			category = category.replace('emoji-','');
		}else if(type=='pinup'){
			category = category.replace('pinup-','');
		}
		var result = {
			"type":type,
			"category":category,
			"emoji":emoji
		};
		// 隐藏  表情
		if(that._callback instanceof Function){
			that._callback.call(this,result);
			that._$hide();
		}
	});

	this._$addEvent(this.tmpguan,'click',function(event){
		var target = that._$getElement(event);
		if(target.tagName.toLowerCase()!='b'){
			return;
		}		
		// 隐藏  表情
		if(that._callback instanceof Function){
			that._$hide();
		}
	});
}

//显示控件
CEmojiEngine.prototype._$show = function(){
	this._curEmojiType = 'emoji-emoji';	//初始化当前默认表情选择
	this._curEmojiNode = document.getElementById('chn-emoji-emoji');
	this.__renderPictureCol();		//渲染表情图片栏
	var tags = this._changeColumn.getElementsByTagName('span');
	var that = this;
	setTimeout(function(){
		that._parentNode.style.display = 'block';		//阻止冒泡产生的负效应
	},20);
}

//隐藏控件
CEmojiEngine.prototype._$hide = function(){
	this._parentNode.style.display = 'none';
}

//关于事件绑定的原生对象
CEmojiEngine.prototype._$addEvent = function(element,type,callback){
	if(!!element.addEventListener){
		element.addEventListener(type,callback,false);
	}else if(!!element.attachEvent){
		element.attachEvent('on'+type,callback);
	}else{
	}
};

CEmojiEngine.prototype._$stop = function(event){
	event=event?event:window.event; 
	if(!!event.stopPropogation){
		event.stopPropogation();
	}else{
		event.cancelBubble=true;
	}
};

CEmojiEngine.prototype._$getElement = function(event){
	event = event||window.event;
	var target = event.target||event.srcElement;
	return target;
};