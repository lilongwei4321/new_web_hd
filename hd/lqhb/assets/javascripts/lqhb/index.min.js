$(function(){
    var es = $(".lqhb_wrap")[0].scrollHeigh,
        zjfrom    = getQueryString('zjfrom')!=null?getQueryString('zjfrom'):getCookie('zjfrom'),
        tgjh      = getQueryString('tgjh')!=null?getQueryString('tgjh'):getCookie('tgjh'),
        tgdy      = getQueryString('tgdy')!=null?getQueryString('tgdy'):getCookie('tgdy'),
        gjc       = getQueryString('gjc')!=null?getQueryString('gjc'):getCookie('gjc'),
        gjcpm     = getQueryString('gjcpm')!=null?getQueryString('gjcpm'):getCookie('gjcpm'),
        gjcppms   = getQueryString('gjcppms')!=null?getQueryString('gjcppms'):getCookie('gjcppms'),
        tgcy      = getQueryString('tgcy')!=null?getQueryString('tgcy'):getCookie('tgcy'),
        ggsc      = getQueryString('ggsc')!=null?getQueryString('ggsc'):getCookie('ggsc'),
        ggw       = getQueryString('ggw')!=null?getQueryString('ggw'):getCookie('ggw'),
        pd        = getQueryString('pd')!=null?getQueryString('pd'):getCookie('pd'),
        xq        = getQueryString('xq')!=null?getQueryString('xq'):getCookie('xq'),
        xb        = getQueryString('xb')!=null?getQueryString('xb'):getCookie('xb'),
        nld       = getQueryString('nld')!=null?getQueryString('nld'):getCookie('nld'),
        sb        = '',
        reg = /^1[34578]\d{9}$/;
    $(".lqhb_wrap").css({ "height": es + "px" });
    $("#user_yanzmBtn").attr('disabled',true);

    /*判断当前 设备*/
    function IsPC() {
        var userAgentInfo = navigator.userAgent;
        var Agents = ["Android", "iPhone","SymbianOS","Windows Phone","iPad","iPod","MeeGo","Touch","RIM Tablet OS"];
        var flag = true;
        for (var v = 0; v < Agents.length; v++) {
            if(userAgentInfo.indexOf(Agents[v]) > 0) {
              flag = false;
              break;
            }
        }
        return flag;
    }

    /* 根据设备  显示不同样式 */

    if(!IsPC()){
        $('#lqhb_back').attr('src','assets/images/lqhb/lqhb_back.png');
        $("#message_title").attr("src",'assets/images/lqhb/message_title.png');
        /*更改根类名*/
        $("#lqhb_wrap").removeClass('lqhb_wrap1').addClass('lqhb_wrap');
        sb = 'm';
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?03cf2b129bc3e77b681764ab590e4c39";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    }
    else{
        $('#lqhb_back').attr('src','assets/images/lqhb/pc_back.png');
        $("#message_title").attr("src",'assets/images/lqhb/pc_message_title.png');
        $("#lqhb_wrap").removeClass('lqhb_wrap').addClass('lqhb_wrap1');
        $(".flex").removeClass('flex');
        sb  = 'pc';
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?d3e30511a214ab27c29703983af591cb";
          var s = document.getElementsByTagName("script")[0]; 
          s.parentNode.insertBefore(hm, s);
        })();
    }
    //取得地址栏  指定参数
    function getQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
            var r = window.location.search.substr(1).match(reg);
        try {
            return decodeURI(r[2]); 
        } catch(e){
            try {
                return $URL.decode(r[2]); 
            }catch(e) {
                return null;
            } 
        }   	
    }
        /*cookie 存储zjfrom 的值*/
    function setCookie(name,value,days){
        var Days = 1000 ;
        var exp = new Date();
        exp.setTime(exp.getTime() + Days*24*60*60*1000);
        document.cookie = name + "="+ encodeURI (value) + ";expires=" + exp.toGMTString()+";domain = zeju.com"+";path=/";
    }
    //获取cookie
    function getCookie(name) {
        var arr,reg=new RegExp("(^| )"+name+"=([^;]*)(;|$)");
        if(arr=document.cookie.match(reg)){
          return decodeURI(arr[2]); 
        } else {
        return null;
        }
    }

    $("#lqhb_btn").on("click", function(e) {
       /* e.preventDefault();*/
        var userName = $("#user_name").val(),
            userPhone = $("#user_phone").val(),
            userYanzm = $("#user_yanzm").val();

        if(userName=='' || userName.length>16){
            $("#user_error").text("请输入正确称呼！");
            return false;
        }

        if(userPhone =='' || !reg.test(userPhone)){
            $("#user_error").text("请输入正确的手机号！");
            return false;
        } 

        if(userYanzm ==''){
            $("#user_error").text("请输入正确的验证码！");
            return false;
        }

        
        $.ajax({
            type: "POST",
            url: "http://webapi.zeju.com/liuzi/lqhb",
            data: { 
                nick_name: userName,
                phone    : userPhone,
                code     : ""+userYanzm+"",
                zjfrom   : zjfrom,
                tgjh     : tgjh,
                tgdy     : tgdy,
                gjc      : gjc,
                gjcppms  : gjcppms,
                gjcpm    : gjcpm,
                tgcy     : tgcy,
                ggsc     : ggsc,
                ggw      : ggw,
                pd       : pd,
                xq       : xq,
                xb       : xb,
                nld      : nld,
                tgsb       : sb,
                clue_type_id :"6"
            },
            dataType: "json",
            success: function(data) {
                if (data.status == "fail"){
                    $("#user_error").text("请输入正确的验证码！");
                } 
                else if (data.status == "succeed"){
                    $(".lqhb_pic").css({ "display": "block" });
                    $(".lqhb_form").css({ "display": "none" });
                    $("#user_error").text("您已成功领取红包");
                    setTimeout(function(){
                        window.history.go(-1); 
                    },3000)
                } 
                else if (data.status == "participated"){
                   $("#user_error").text("此手机号已领取红包，请不要重复提交");
                }
            }
        })
    })
    /*手机号输入   变类名*/
    $("#user_phone").on("keyup", function(){
        if($(this).val()!=''){
            $("#user_yanzmBtn").attr("disabled", false);
            $("#user_yanzmBtn").addClass("yanzm_btncolor");
        } else {
            $("#user_yanzmBtn").attr("disabled", true);
            $("#user_yanzmBtn").removeClass("yanzm_btncolor");
        }
        
    })

    /*获取验证码*/
    $("#user_yanzmBtn").on('click',function(){
        var userPhone = $("#user_phone").val();
        if(userPhone=='' || !reg.test(userPhone)){
            $("#user_error").text("请输入正确的手机号！");
        }
        else{
            $("#user_error").text("");
            $("#user_phone").attr('disabled',true);
            sendCode("#user_phone", "#user_yanzmBtn", false, 60);
        }
    })

    if(getQueryString('zjfrom')!=null){setCookie("zjfrom",zjfrom);}
    if(getQueryString('tgjh')!=null){setCookie("tgjh",tgjh);}
    if(getQueryString('tgdy')!=null){setCookie("tgdy",tgdy);}
    if(getQueryString('gjc')!=null){setCookie("gjc",gjc);}
    if(getQueryString('gjcpm')!=null){setCookie("gjcpm",gjcpm);}
    if(getQueryString('gjcppms')!=null){setCookie("gjcppms",gjcppms);}
    if(getQueryString('tgcy')!=null){setCookie("tgcy",tgcy);}
    if(getQueryString('ggsc')!=null){setCookie("ggsc",ggsc);}
    if(getQueryString('ggw')!=null){setCookie("ggw",ggw);}
    if(getQueryString('pd')!=null){setCookie("pd",pd);}
    if(getQueryString('xq')!=null){setCookie("xq",xq);}
    if(getQueryString('xb')!=null){setCookie("xb",xb);}
    if(getQueryString('nld')!=null){setCookie("nld",nld);} 
})